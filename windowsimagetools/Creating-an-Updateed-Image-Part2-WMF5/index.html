<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin SEO -->









<title>Windows Image Tools | Creating an Updated Image Part 2 - PowerShell Journey</title>




<meta name="description" content="One of the time consuming steps to deploying new VMs is the time spend managing Images and and applying patches. I’m not big on Golden images. I tend to use a fully patched VHDX or VMDK  and let DSC handle the configuration and software. This is not the fastest, and at scale you need to create more then one image based on what saves the most time.  (IIS, SQL, Exchange, etc…).">




<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="PowerShell Journey">
<meta property="og:title" content="Windows Image Tools | Creating an Updated Image Part 2">


  <link rel="canonical" href="http://localhost:4000/windowsimagetools/Creating-an-Updateed-Image-Part2-WMF5/">
  <meta property="og:url" content="http://localhost:4000/windowsimagetools/Creating-an-Updateed-Image-Part2-WMF5/">



  <meta property="og:description" content="One of the time consuming steps to deploying new VMs is the time spend managing Images and and applying patches. I’m not big on Golden images. I tend to use a fully patched VHDX or VMDK  and let DSC handle the configuration and software. This is not the fastest, and at scale you need to create more then one image based on what saves the most time.  (IIS, SQL, Exchange, etc…).">



  <meta name="twitter:site" content="@BladeFireLight">
  <meta name="twitter:title" content="Windows Image Tools | Creating an Updated Image Part 2">
  <meta name="twitter:description" content="One of the time consuming steps to deploying new VMs is the time spend managing Images and and applying patches. I’m not big on Golden images. I tend to use a fully patched VHDX or VMDK  and let DSC handle the configuration and software. This is not the fastest, and at scale you need to create more then one image based on what saves the most time.  (IIS, SQL, Exchange, etc…).">
  <meta name="twitter:url" content="http://localhost:4000/windowsimagetools/Creating-an-Updateed-Image-Part2-WMF5/">

  
    <meta name="twitter:card" content="summary">
    
  

  



  

  





  <meta property="og:type" content="article">
  <meta property="article:published_time" content="2016-09-01T16:48:59-05:00">








  <script type="application/ld+json">
    {
      "@context" : "http://schema.org",
      "@type" : "Person",
      "name" : "David Jones",
      "url" : "http://localhost:4000",
      "sameAs" : null
    }
  </script>






<!-- end SEO -->


<link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="PowerShell Journey Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="http://localhost:4000/assets/css/main.css">

<meta http-equiv="cleartype" content="on">
    <!-- start custom head snippets -->

<!-- insert favicons. use http://realfavicongenerator.net/ -->

<!-- end custom head snippets -->
  </head>

  <body class="layout--single">

    <!--[if lt IE 11]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->
    <div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <button><div class="navicon"></div></button>
        <ul class="visible-links">
          <li class="masthead__menu-item masthead__menu-item--lg"><a href="http://localhost:4000/">PowerShell Journey</a></li>
          
            
            <li class="masthead__menu-item"><a href="http://localhost:4000/about/">About</a></li>
          
            
            <li class="masthead__menu-item"><a href="http://localhost:4000/Nuggets/">Nuggets</a></li>
          
            
            <li class="masthead__menu-item"><a href="http://localhost:4000/windowsimagetools/">Windows Image Tools</a></li>
          
            
            <li class="masthead__menu-item"><a href="http://localhost:4000/windowsimagetools/">PKI Tools</a></li>
          
            
            <li class="masthead__menu-item"><a href="http://localhost:4000/year-archive/">Archive by Date</a></li>
          
            
            <li class="masthead__menu-item"><a href="http://localhost:4000/categories/">By Category</a></li>
          
            
            <li class="masthead__menu-item"><a href="http://localhost:4000/tags/">By Tag</a></li>
          
        </ul>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>

    


  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="http://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
          <a href="http://localhost:4000/" itemprop="item"><span itemprop="name">Home</span></a>
          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">/</span>
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
          <a href="http://localhost:4000/windowsimagetools" itemprop="item"><span itemprop="name">Windowsimagetools</span></a>
          <meta itemprop="position" content="2" />
        </li>
        <span class="sep">/</span>
      
    
      
      
        <li class="current">Windows Image Tools | Creating an Updated Image Part 2</li>
      
    
  </ol>
</nav>
  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  

<div itemscope itemtype="http://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="http://localhost:4000/assets/images/avatar1.jpg" class="author__avatar" alt="David Jones" itemprop="image">
      
    </div>
  

  <div class="author__content">
    <h3 class="author__name" itemprop="name">David Jones</h3>
    
      <p class="author__bio" itemprop="description">
        20 years IT Pro. life long student of tech
      </p>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="http://schema.org/Place">
          <i class="fa fa-fw fa-map-marker" aria-hidden="true"></i> <span itemprop="name">Gretna, NE</span>
        </li>
      

      

      
        <li>
          <a href="mailto:BladeFireLight@outlook.com">
            <meta itemprop="email" content="BladeFireLight@outlook.com" />
            <i class="fa fa-fw fa-envelope-square" aria-hidden="true"></i> Email
          </a>
        </li>
      

      

      
        <li>
          <a href="https://twitter.com/BladeFireLight" itemprop="sameAs">
            <i class="fa fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter
          </a>
        </li>
      

      

      

      

      

      

      

      

      
        <li>
          <a href="https://github.com/BladeFireLight" itemprop="sameAs">
            <i class="fa fa-fw fa-github" aria-hidden="true"></i> GitHub
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs">
      <i class="fa fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
    <meta itemprop="headline" content="Windows Image Tools | Creating an Updated Image Part 2">
    <meta itemprop="description" content="One of the time consuming steps to deploying new VMs is the time spend managing Images and and applying patches. I’m not big on Golden images. I tend to use a fully patched VHDX or VMDK  and let DSC handle the configuration and software. This is not the fastest, and at scale you need to create more then one image based on what saves the most time.  (IIS, SQL, Exchange, etc…).">
    <meta itemprop="datePublished" content="September 01, 2016">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 class="page__title" itemprop="headline">Windows Image Tools | Creating an Updated Image Part 2
</h1>
          
            <p class="page__meta"><i class="fa fa-clock-o" aria-hidden="true"></i> 




  4 minute read
</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        <aside class="sidebar__right">
<nav class="toc">
    <header><h4 class="nav__title"><i class="fa fa-file-text"></i> On This Page</h4></header>
<ul class="toc__menu" id="markdown-toc">
  <li><a href="#plan-for-today" id="markdown-toc-plan-for-today">Plan for today</a></li>
  <li><a href="#prerequisites" id="markdown-toc-prerequisites">Prerequisites</a></li>
  <li><a href="#updating-wmf" id="markdown-toc-updating-wmf">Updating WMF</a></li>
</ul>

  </nav>
</aside>

<h2 id="plan-for-today">Plan for today</h2>

<p>Windows Management Framework contains PowerShell. You should always run the latest supported in your environment, and it’s a good idea to get your hands on the preview and give it test run. I want my 2012r2 servers to be running WMF 5.0 the current stable realease.</p>

<p>Now I could install 5.1 preview, but as it has to be uninstalled when the final get’s released, so I’m going to pass for now.</p>

<h2 id="prerequisites">Prerequisites</h2>

<p>If you folowing along you will need the WindowsImageTools update folder and two VHDX created in the last blog</p>

<h2 id="updating-wmf">Updating WMF</h2>

<p>Using Update-WindowsImageWMF we will download WMF 5.0 and .net 4.6.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>PS G:\&gt; Update-WindowsImageWMF -Path G:\Blog_Example\ -ImageName Srv2012r2_Core -Verbose
</code></pre>
</div>

<p>First it’s going to create a child vhdx so we can revert if things go south</p>

<div class="highlighter-rouge"><pre class="highlight"><code>VERBOSE: Performing the operation "Update WMF in Windows Image Tools Update Image" on target
"G:\Blog_Example\\BaseImage\Srv2012r2_Core_Base.vhdx".
VERBOSE: [Update-WindowsImageWMF] : Creating G:\Blog_Example\\BaseImage\Srv2012r2_Core_Update.vhdx from
G:\Blog_Example\\BaseImage\Srv2012r2_Core_Base.vhdx
</code></pre>
</div>

<p>Then it’s going to download the installer packages</p>

<div class="highlighter-rouge"><pre class="highlight"><code>VERBOSE: [Update-WindowsImageWMF] : Checking for the latest WMF in G:\Blog_Example\\Resource\WMF\5
VERBOSE: GET https://www.microsoft.com/en-us/download/details.aspx?id=50395 with 0-byte payload
VERBOSE: received 107311-byte response of content type text/html
VERBOSE: GET http://www.microsoft.com/en-us/download/confirmation.aspx?id=50395 with 0-byte payload
VERBOSE: received -1-byte response of content type text/html
WARNING: [Update-WindowsImageWMF] : Checking for the latest WMF : W2K12-KB3134759-x64.msu Missing, Downloading
VERBOSE: GET https://download.microsoft.com/download/2/C/6/2C6E1B4A-EBE5-48A6-B225-2D2058A9CEFB/W2K12-KB3134759-x64.msu
 with 0-byte payload
VERBOSE: received 21540661-byte response of content type application/octet-stream
VERBOSE: [Update-WindowsImageWMF] : Checking for the latest WMF :
G:\Blog_Example\\Resource\WMF\5\W2K12-KB3134759-x64.msu : Found
WARNING: [Update-WindowsImageWMF] : Checking for the latest WMF : Win7AndW2K8R2-KB3134760-x64.msu Missing, Downloading
VERBOSE: GET
https://download.microsoft.com/download/2/C/6/2C6E1B4A-EBE5-48A6-B225-2D2058A9CEFB/Win7AndW2K8R2-KB3134760-x64.msu with
 0-byte payload
VERBOSE: received 21779572-byte response of content type application/octet-stream
VERBOSE: [Update-WindowsImageWMF] : Checking for the latest WMF :
G:\Blog_Example\\Resource\WMF\5\Win7AndW2K8R2-KB3134760-x64.msu : Found
WARNING: [Update-WindowsImageWMF] : Checking for the latest WMF : Win7-KB3134760-x86.msu Missing, Downloading
VERBOSE: GET https://download.microsoft.com/download/2/C/6/2C6E1B4A-EBE5-48A6-B225-2D2058A9CEFB/Win7-KB3134760-x86.msu
with 0-byte payload
VERBOSE: received 16961221-byte response of content type application/octet-stream
VERBOSE: [Update-WindowsImageWMF] : Checking for the latest WMF :
G:\Blog_Example\\Resource\WMF\5\Win7-KB3134760-x86.msu : Found
WARNING: [Update-WindowsImageWMF] : Checking for the latest WMF : Win8.1AndW2K12R2-KB3134758-x64.msu Missing,
Downloading
VERBOSE: GET
https://download.microsoft.com/download/2/C/6/2C6E1B4A-EBE5-48A6-B225-2D2058A9CEFB/Win8.1AndW2K12R2-KB3134758-x64.msu
with 0-byte payload
VERBOSE: received 19764832-byte response of content type application/octet-stream
VERBOSE: [Update-WindowsImageWMF] : Checking for the latest WMF :
G:\Blog_Example\\Resource\WMF\5\Win8.1AndW2K12R2-KB3134758-x64.msu : Found
WARNING: [Update-WindowsImageWMF] : Checking for the latest WMF : Win8.1-KB3134758-x86.msu Missing, Downloading
VERBOSE: GET
https://download.microsoft.com/download/2/C/6/2C6E1B4A-EBE5-48A6-B225-2D2058A9CEFB/Win8.1-KB3134758-x86.msu with 0-byte
 payload
VERBOSE: received 15059790-byte response of content type application/octet-stream
VERBOSE: [Update-WindowsImageWMF] : Checking for the latest WMF :
G:\Blog_Example\\Resource\WMF\5\Win8.1-KB3134758-x86.msu : Found
VERBOSE: [Update-WindowsImageWMF] : Checking for .NET 4.6.1 installer
WARNING: [Update-WindowsImageWMF] : Checking for .NET 4.6 installer : Missing : Downloading
VERBOSE: GET
https://download.microsoft.com/download/E/4/1/E4173890-A24A-4936-9FC9-AF930FE3FA40/NDP461-KB3102436-x86-x64-AllOS-ENU.e
xe with 0-byte payload
VERBOSE: received 67681000-byte response of content type application/octet-stream
</code></pre>
</div>

<p>Now it will copy the .NET installer and an AtStartup.ps1 to run the install.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>VERBOSE: [Update-WindowsImageWMF] : .NET : Adding installer to G:\Blog_Example\\BaseImage\Srv2012r2_Core_Update.vhdx
VERBOSE: [Update-WindowsImageWMF] : .NET : updateting AtStartup script
</code></pre>
</div>
<p>It is going to create a VM with a random name and wait for it to stop. 
While it’s running the AtStartup script will install .net, reboot and check the version of .net
If it find’s what it’s expecting it creates a file that Update-WindowsImageWMF will look for to decide if it can continue.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>VERBOSE: [Update-WindowsImageWMF] : .NET : Creating temp vm and waiting
VERBOSE: [createRunAndWaitVM] : Creating VM s4gzlpa4 at 09/22/2016 16:54:47
VERBOSE: [createRunAndWaitVM] : VM s4gzlpa4 Stoped
VERBOSE: [createRunAndWaitVM] : VM s4gzlpa4 Deleted at 09/22/2016 17:12:52
</code></pre>
</div>

<p>You cant use PowerShell to WMF because that updates PowerShell. So It will apply the MSU to the VHDX.
Now because Update-WindowsImageWMF does not know what OS is inside the vhdx. It will apply them all. Unfortunetly DISM (that does the work) reports succses when the MSU does not apply to that version of the OS. So it looks like all of the are installing but only the one that should actualy does.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>VERBOSE: [Update-WindowsImageWMF] : WMF : Applying WMF to G:\Blog_Example\\BaseImage\Srv2012r2_Core_Update.vhdx and
Updating AtStartup script
VERBOSE: checking if G:\Blog_Example\Resource\WMF\5\W2K12-KB3134759-x64.msu applies to
G:\Blog_Example\\BaseImage\Srv2012r2_Core_Update.vhdx
VERBOSE: Target Image Version 6.3.9600.17031
VERBOSE: Successfully added package G:\Blog_Example\Resource\WMF\5\W2K12-KB3134759-x64.msu
VERBOSE: checking if G:\Blog_Example\Resource\WMF\5\Win7-KB3134760-x86.msu applies to
G:\Blog_Example\\BaseImage\Srv2012r2_Core_Update.vhdx
VERBOSE: Target Image Version 6.3.9600.17031
VERBOSE: Successfully added package G:\Blog_Example\Resource\WMF\5\Win7-KB3134760-x86.msu
VERBOSE: checking if G:\Blog_Example\Resource\WMF\5\Win7AndW2K8R2-KB3134760-x64.msu applies to
G:\Blog_Example\\BaseImage\Srv2012r2_Core_Update.vhdx
VERBOSE: Target Image Version 6.3.9600.17031
VERBOSE: Successfully added package G:\Blog_Example\Resource\WMF\5\Win7AndW2K8R2-KB3134760-x64.msu
VERBOSE: checking if G:\Blog_Example\Resource\WMF\5\Win8.1-KB3134758-x86.msu applies to
G:\Blog_Example\\BaseImage\Srv2012r2_Core_Update.vhdx
VERBOSE: Target Image Version 6.3.9600.17031
VERBOSE: Successfully added package G:\Blog_Example\Resource\WMF\5\Win8.1-KB3134758-x86.msu
VERBOSE: checking if G:\Blog_Example\Resource\WMF\5\Win8.1AndW2K12R2-KB3134758-x64.msu applies to
G:\Blog_Example\\BaseImage\Srv2012r2_Core_Update.vhdx
VERBOSE: Target Image Version 6.3.9600.17031
VERBOSE: Successfully added package G:\Blog_Example\Resource\WMF\5\Win8.1AndW2K12R2-KB3134758-x64.msu
</code></pre>
</div>
<p>To finalize the install Update-WindowsImageWMF needs to create a vm and let it finish installing then run a AtStartup script to check the version of PowerShell to validate the install worked. and if so write a flag file.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>VERBOSE: [Update-WindowsImageWMF] : WMF : creating temp VM to finalize install on
G:\Blog_Example\\BaseImage\Srv2012r2_Core_Update.vhdx
VERBOSE: [createRunAndWaitVM] : Creating VM yary1ogs at 09/22/2016 17:15:55
VERBOSE: [createRunAndWaitVM] : VM yary1ogs Stoped
VERBOSE: [createRunAndWaitVM] : VM yary1ogs Deleted at 09/22/2016 17:18:17
</code></pre>
</div>

<p>If the flag file is detected then the child vhdx is merged back into the base. if not the child file id discarded and an error thrown</p>

<div class="highlighter-rouge"><pre class="highlight"><code>VERBOSE: [Update-WindowsImageWMF] : WMF : Checking if changes made
VERBOSE: [Update-WindowsImageWMF] : WMF : Changes found : Merging G:\Blog_Example\\BaseImage\Srv2012r2_Core_Update.vhdx
 into G:\Blog_Example\\BaseImage\Srv2012r2_Core_Base.vhdx
</code></pre>
</div>

<p>I’m going to run the same command again on the other vhdx</p>

<figure class="highlight">
  <code>
<span style="color:#E0FFFF;">Update-WindowsImageWMF&nbsp;</span><span style="color:#FFE4B5;">-Path&nbsp;</span><span style="color:#EE82EE;">G:\Blog_Example\&nbsp;</span><span style="color:#FFE4B5;">-ImageName&nbsp;</span><span style="color:#EE82EE;">Srv2012r2_Source&nbsp;</span><span style="color:#FFE4B5;">-Verbose</span><br class="" />

<span style="color:#00FFFF;">VERBOSE:&nbsp;Performing&nbsp;the&nbsp;operation&nbsp;&quot;Update&nbsp;WMF&nbsp;in&nbsp;Windows&nbsp;Image&nbsp;Tools&nbsp;Update&nbsp;Image&quot;&nbsp;on&nbsp;target&nbsp;&quot;G:\Blog_Example\\BaseImage\Srv2012r2_Source_Base.vhdx&quot;.</span><br class="" /><span style="color:#00FFFF;">VERBOSE:&nbsp;[Update-WindowsImageWMF]&nbsp;:&nbsp;Creating&nbsp;G:\Blog_Example\\BaseImage\Srv2012r2_Source_Update.vhdx&nbsp;from&nbsp;G:\Blog_Example\\BaseImage\Srv2012r2_Source_Base.vhdx</span><br class="" /><span style="color:#00FFFF;">VERBOSE:&nbsp;[Update-WindowsImageWMF]&nbsp;:&nbsp;Checking&nbsp;for&nbsp;the&nbsp;latest&nbsp;WMF&nbsp;in&nbsp;G:\Blog_Example\\Resource\WMF\5</span><br class="" /><span style="color:#00FFFF;">VERBOSE:&nbsp;GET&nbsp;https://www.microsoft.com/en-us/download/details.aspx?id=50395&nbsp;with&nbsp;0-byte&nbsp;payload</span><br class="" /><span style="color:#00FFFF;">VERBOSE:&nbsp;received&nbsp;107378-byte&nbsp;response&nbsp;of&nbsp;content&nbsp;type&nbsp;text/html</span><br class="" /><span style="color:#00FFFF;">VERBOSE:&nbsp;GET&nbsp;http://www.microsoft.com/en-us/download/confirmation.aspx?id=50395&nbsp;with&nbsp;0-byte&nbsp;payload</span><br class="" /><span style="color:#00FFFF;">VERBOSE:&nbsp;received&nbsp;-1-byte&nbsp;response&nbsp;of&nbsp;content&nbsp;type&nbsp;text/html</span><br class="" /><span style="color:#00FFFF;">VERBOSE:&nbsp;[Update-WindowsImageWMF]&nbsp;:&nbsp;Checking&nbsp;for&nbsp;the&nbsp;latest&nbsp;WMF&nbsp;:&nbsp;G:\Blog_Example\\Resource\WMF\5\W2K12-KB3134759-x64.msu&nbsp;:&nbsp;Found</span><br class="" /><span style="color:#00FFFF;">VERBOSE:&nbsp;[Update-WindowsImageWMF]&nbsp;:&nbsp;Checking&nbsp;for&nbsp;the&nbsp;latest&nbsp;WMF&nbsp;:&nbsp;G:\Blog_Example\\Resource\WMF\5\W2K12-KB3134759-x64.msu&nbsp;:&nbsp;Found</span><br class="" /><span style="color:#00FFFF;">VERBOSE:&nbsp;[Update-WindowsImageWMF]&nbsp;:&nbsp;Checking&nbsp;for&nbsp;the&nbsp;latest&nbsp;WMF&nbsp;:&nbsp;G:\Blog_Example\\Resource\WMF\5\Win7AndW2K8R2-KB3134760-x64.msu&nbsp;:&nbsp;Found</span><br class="" /><span style="color:#00FFFF;">VERBOSE:&nbsp;[Update-WindowsImageWMF]&nbsp;:&nbsp;Checking&nbsp;for&nbsp;the&nbsp;latest&nbsp;WMF&nbsp;:&nbsp;G:\Blog_Example\\Resource\WMF\5\Win7AndW2K8R2-KB3134760-x64.msu&nbsp;:&nbsp;Found</span><br class="" /><span style="color:#00FFFF;">VERBOSE:&nbsp;[Update-WindowsImageWMF]&nbsp;:&nbsp;Checking&nbsp;for&nbsp;the&nbsp;latest&nbsp;WMF&nbsp;:&nbsp;G:\Blog_Example\\Resource\WMF\5\Win7-KB3134760-x86.msu&nbsp;:&nbsp;Found</span><br class="" /><span style="color:#00FFFF;">VERBOSE:&nbsp;[Update-WindowsImageWMF]&nbsp;:&nbsp;Checking&nbsp;for&nbsp;the&nbsp;latest&nbsp;WMF&nbsp;:&nbsp;G:\Blog_Example\\Resource\WMF\5\Win7-KB3134760-x86.msu&nbsp;:&nbsp;Found</span><br class="" /><span style="color:#00FFFF;">VERBOSE:&nbsp;[Update-WindowsImageWMF]&nbsp;:&nbsp;Checking&nbsp;for&nbsp;the&nbsp;latest&nbsp;WMF&nbsp;:&nbsp;G:\Blog_Example\\Resource\WMF\5\Win8.1AndW2K12R2-KB3134758-x64.msu&nbsp;:&nbsp;Found</span><br class="" /><span style="color:#00FFFF;">VERBOSE:&nbsp;[Update-WindowsImageWMF]&nbsp;:&nbsp;Checking&nbsp;for&nbsp;the&nbsp;latest&nbsp;WMF&nbsp;:&nbsp;G:\Blog_Example\\Resource\WMF\5\Win8.1AndW2K12R2-KB3134758-x64.msu&nbsp;:&nbsp;Found</span><br class="" /><span style="color:#00FFFF;">VERBOSE:&nbsp;[Update-WindowsImageWMF]&nbsp;:&nbsp;Checking&nbsp;for&nbsp;the&nbsp;latest&nbsp;WMF&nbsp;:&nbsp;G:\Blog_Example\\Resource\WMF\5\Win8.1-KB3134758-x86.msu&nbsp;:&nbsp;Found</span><br class="" /><span style="color:#00FFFF;">VERBOSE:&nbsp;[Update-WindowsImageWMF]&nbsp;:&nbsp;Checking&nbsp;for&nbsp;the&nbsp;latest&nbsp;WMF&nbsp;:&nbsp;G:\Blog_Example\\Resource\WMF\5\Win8.1-KB3134758-x86.msu&nbsp;:&nbsp;Found</span><br class="" /><span style="color:#00FFFF;">VERBOSE:&nbsp;[Update-WindowsImageWMF]&nbsp;:&nbsp;Checking&nbsp;for&nbsp;.NET&nbsp;4.6.1&nbsp;installer</span><br class="" /><span style="color:#00FFFF;">VERBOSE:&nbsp;[Update-WindowsImageWMF]&nbsp;:&nbsp;.NET&nbsp;:&nbsp;Adding&nbsp;installer&nbsp;to&nbsp;G:\Blog_Example\\BaseImage\Srv2012r2_Source_Update.vhdx</span><br class="" /><span style="color:#00FFFF;">VERBOSE:&nbsp;[Update-WindowsImageWMF]&nbsp;:&nbsp;.NET&nbsp;:&nbsp;updateting&nbsp;AtStartup&nbsp;script</span><br class="" /><span style="color:#00FFFF;">VERBOSE:&nbsp;[Update-WindowsImageWMF]&nbsp;:&nbsp;.NET&nbsp;:&nbsp;Creating&nbsp;temp&nbsp;vm&nbsp;and&nbsp;waiting</span><br class="" /><span style="color:#00FFFF;">VERBOSE:&nbsp;[createRunAndWaitVM]&nbsp;:&nbsp;Creating&nbsp;VM&nbsp;dkdjxvqm&nbsp;at&nbsp;09/23/2016&nbsp;08:56:23</span><br class="" /><span style="color:#00FFFF;">VERBOSE:&nbsp;[createRunAndWaitVM]&nbsp;:&nbsp;VM&nbsp;dkdjxvqm&nbsp;Stoped</span><br class="" /><span style="color:#00FFFF;">VERBOSE:&nbsp;[createRunAndWaitVM]&nbsp;:&nbsp;VM&nbsp;dkdjxvqm&nbsp;Deleted&nbsp;at&nbsp;09/23/2016&nbsp;09:12:39</span><br class="" /><span style="color:#00FFFF;">VERBOSE:&nbsp;[Update-WindowsImageWMF]&nbsp;:&nbsp;WMF&nbsp;:&nbsp;Applying&nbsp;WMF&nbsp;to&nbsp;G:\Blog_Example\\BaseImage\Srv2012r2_Source_Update.vhdx&nbsp;and&nbsp;Updating&nbsp;AtStartup&nbsp;script</span><br class="" /><span style="color:#00FFFF;">VERBOSE:&nbsp;checking&nbsp;if&nbsp;G:\Blog_Example\Resource\WMF\5\W2K12-KB3134759-x64.msu&nbsp;applies&nbsp;to&nbsp;G:\Blog_Example\\BaseImage\Srv2012r2_Source_Update.vhdx</span><br class="" /><span style="color:#00FFFF;">VERBOSE:&nbsp;Target&nbsp;Image&nbsp;Version&nbsp;6.3.9600.17031</span><br class="" /><span style="color:#00FFFF;">VERBOSE:&nbsp;Successfully&nbsp;added&nbsp;package&nbsp;G:\Blog_Example\Resource\WMF\5\W2K12-KB3134759-x64.msu</span><br class="" /><span style="color:#00FFFF;">VERBOSE:&nbsp;checking&nbsp;if&nbsp;G:\Blog_Example\Resource\WMF\5\Win7-KB3134760-x86.msu&nbsp;applies&nbsp;to&nbsp;G:\Blog_Example\\BaseImage\Srv2012r2_Source_Update.vhdx</span><br class="" /><span style="color:#00FFFF;">VERBOSE:&nbsp;Target&nbsp;Image&nbsp;Version&nbsp;6.3.9600.17031</span><br class="" /><span style="color:#00FFFF;">VERBOSE:&nbsp;Successfully&nbsp;added&nbsp;package&nbsp;G:\Blog_Example\Resource\WMF\5\Win7-KB3134760-x86.msu</span><br class="" /><span style="color:#00FFFF;">VERBOSE:&nbsp;checking&nbsp;if&nbsp;G:\Blog_Example\Resource\WMF\5\Win7AndW2K8R2-KB3134760-x64.msu&nbsp;applies&nbsp;to&nbsp;G:\Blog_Example\\BaseImage\Srv2012r2_Source_Update.vhdx</span><br class="" /><span style="color:#00FFFF;">VERBOSE:&nbsp;Target&nbsp;Image&nbsp;Version&nbsp;6.3.9600.17031</span><br class="" /><span style="color:#00FFFF;">VERBOSE:&nbsp;Successfully&nbsp;added&nbsp;package&nbsp;G:\Blog_Example\Resource\WMF\5\Win7AndW2K8R2-KB3134760-x64.msu</span><br class="" /><span style="color:#00FFFF;">VERBOSE:&nbsp;checking&nbsp;if&nbsp;G:\Blog_Example\Resource\WMF\5\Win8.1-KB3134758-x86.msu&nbsp;applies&nbsp;to&nbsp;G:\Blog_Example\\BaseImage\Srv2012r2_Source_Update.vhdx</span><br class="" /><span style="color:#00FFFF;">VERBOSE:&nbsp;Target&nbsp;Image&nbsp;Version&nbsp;6.3.9600.17031</span><br class="" /><span style="color:#00FFFF;">VERBOSE:&nbsp;Successfully&nbsp;added&nbsp;package&nbsp;G:\Blog_Example\Resource\WMF\5\Win8.1-KB3134758-x86.msu</span><br class="" /><span style="color:#00FFFF;">VERBOSE:&nbsp;checking&nbsp;if&nbsp;G:\Blog_Example\Resource\WMF\5\Win8.1AndW2K12R2-KB3134758-x64.msu&nbsp;applies&nbsp;to&nbsp;G:\Blog_Example\\BaseImage\Srv2012r2_Source_Update.vhdx</span><br class="" /><span style="color:#00FFFF;">VERBOSE:&nbsp;Target&nbsp;Image&nbsp;Version&nbsp;6.3.9600.17031</span><br class="" /><span style="color:#00FFFF;">VERBOSE:&nbsp;Successfully&nbsp;added&nbsp;package&nbsp;G:\Blog_Example\Resource\WMF\5\Win8.1AndW2K12R2-KB3134758-x64.msu</span><br class="" /><span style="color:#00FFFF;">VERBOSE:&nbsp;[Update-WindowsImageWMF]&nbsp;:&nbsp;WMF&nbsp;:&nbsp;creating&nbsp;temp&nbsp;VM&nbsp;to&nbsp;finalize&nbsp;install&nbsp;on&nbsp;G:\Blog_Example\\BaseImage\Srv2012r2_Source_Update.vhdx</span><br class="" /><span style="color:#00FFFF;">VERBOSE:&nbsp;[createRunAndWaitVM]&nbsp;:&nbsp;Creating&nbsp;VM&nbsp;e5h2cc34&nbsp;at&nbsp;09/23/2016&nbsp;09:15:50</span><br class="" /><span style="color:#00FFFF;">VERBOSE:&nbsp;[createRunAndWaitVM]&nbsp;:&nbsp;VM&nbsp;e5h2cc34&nbsp;Stoped</span><br class="" /><span style="color:#00FFFF;">VERBOSE:&nbsp;[createRunAndWaitVM]&nbsp;:&nbsp;VM&nbsp;e5h2cc34&nbsp;Deleted&nbsp;at&nbsp;09/23/2016&nbsp;09:18:25</span><br class="" /><span style="color:#00FFFF;">VERBOSE:&nbsp;[Update-WindowsImageWMF]&nbsp;:&nbsp;WMF&nbsp;:&nbsp;Checking&nbsp;if&nbsp;changes&nbsp;made</span><br class="" /><span style="color:#00FFFF;">VERBOSE:&nbsp;[Update-WindowsImageWMF]&nbsp;:&nbsp;WMF&nbsp;:&nbsp;Changes&nbsp;found&nbsp;:&nbsp;Merging&nbsp;G:\Blog_Example\\BaseImage\Srv2012r2_Source_Update.vhdx&nbsp;into&nbsp;G:\Blog_Example\\BaseImage\Srv2012r2_Source_Base.vhdx</span><br class="" />
 </code>
</figure>

<p>Now I’m going to quickly check to make sure this worked. I dont want to make any changes to the drive as it is so I will create a child vhdx and boot it.</p>

<figure class="highlight">
  <code>
<span style="color:#E0FFFF;">New-VHD</span>&nbsp;<span style="color:#FFE4B5;">-Path</span>&nbsp;<span style="color:#EE82EE;">G:\Blog_Example\BaseImage\Srv2012r2_Core_temp.vhdx</span>&nbsp;<span style="color:#FFE4B5;">-ParentPath</span>&nbsp;<span style="color:#EE82EE;">G:\Blog_Example\BaseImage\Srv2012r2_Core_base.vhdx</span><br class="" /><span style="color:#E0FFFF;">Invoke-CreateVmRunAndWait</span>&nbsp;<span style="color:#FFE4B5;">-VhdPath</span>&nbsp;<span style="color:#EE82EE;">G:\Blog_Example\\BaseImage\Srv2012r2_Core_temp.vhdx</span>&nbsp;<br class="" /><span style="color:#E0FFFF;">Remove-Item</span>&nbsp;<span style="color:#EE82EE;">G:\Blog_Example\\BaseImage\Srv2012r2_Core_temp.vhdx</span>
  </code>
</figure>

<p>checking the psversion table we see what is expected.</p>

<p><img src="http://localhost:4000\assets\images\PS5Version.JPG" alt="PowerShell Version Table" /></p>

<div class="notice--info">
<p><strong>Dealing with 2008/Win7</strong></p>

<p>WMF 5 on 2008 and Win7 need a few patches after WMF 4 is installed. So You want to run windows update before installing WMF 5</p>
</div>

<p>Next up. Windows update and output of WIM/VHDX</p>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fa fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="http://localhost:4000/tags/module" class="page__taxonomy-item" rel="tag">Module</a><span class="sep">, </span>
    
      
      
      <a href="http://localhost:4000/tags/vhdx" class="page__taxonomy-item" rel="tag">VHDX</a><span class="sep">, </span>
    
      
      
      <a href="http://localhost:4000/tags/windowsupdate" class="page__taxonomy-item" rel="tag">WindowsUpdate</a><span class="sep">, </span>
    
      
      
      <a href="http://localhost:4000/tags/windowsupdatetools" class="page__taxonomy-item" rel="tag">WindowsUpdateTools</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fa fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="http://localhost:4000/windowsimagetools" class="page__taxonomy-item" rel="tag">WindowsImageTools</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fa fa-fw fa-calendar" aria-hidden="true"></i> Updated:</strong> <time datetime="2016-09-01T16:48:59-05:00">September 01, 2016</time></p>
        
      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?via=BladeFireLight&text=Windows Image Tools \| Creating an Updated Image Part 2 http://localhost:4000/windowsimagetools/Creating-an-Updateed-Image-Part2-WMF5/" class="btn btn--twitter" title="Share on Twitter"><i class="fa fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/windowsimagetools/Creating-an-Updateed-Image-Part2-WMF5/" class="btn btn--facebook" title="Share on Facebook"><i class="fa fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://plus.google.com/share?url=http://localhost:4000/windowsimagetools/Creating-an-Updateed-Image-Part2-WMF5/" class="btn btn--google-plus" title="Share on Google Plus"><i class="fa fa-fw fa-google-plus" aria-hidden="true"></i><span> Google+</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http://localhost:4000/windowsimagetools/Creating-an-Updateed-Image-Part2-WMF5/" class="btn btn--linkedin" title="Share on LinkedIn"><i class="fa fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="http://localhost:4000/windowsimagetools/Creating-an-Updateed-Image-Part1-Base-VHDX/" class="pagination--pager" title="Windows Image Tools | Creating an Updated Image Part 1
">Previous</a>
    
    
      <a href="http://localhost:4000/windowsimagetools/Creating-an-Updateed-Image-Part3-Updates/" class="pagination--pager" title="Windows Image Tools | Creating an Updated Image Part 3
">Next</a>
    
  </nav>

    </div>

    
      <div class="page__comments">
  
  
    <h4 class="page__comments-title">Leave a Comment</h4>
    <section id="disqus_thread"></section>
  
</div>
    
  </article>

  
  
    <div class="page__related">
      
        <h4 class="page__related-title">You May Also Enjoy</h4>
      
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src=
          
            "http://localhost:4000/assets/images/default-teaser.png"
          
          alt="">
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="http://localhost:4000/windowsimagetools/Creating-an-Updateed-Image-Part3-Updates/" rel="permalink">Windows Image Tools | Creating an Updated Image Part 3
</a>
      
    </h2>
    
      <p class="page__meta"><i class="fa fa-clock-o" aria-hidden="true"></i> 




  less than 1 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">One of the time consuming steps to deploying new VMs is the time spend managing Images and and applying patches. I’m not big on Golden images. I tend to use ...</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src=
          
            "http://localhost:4000/assets/images/default-teaser.png"
          
          alt="">
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="http://localhost:4000/windowsimagetools/Creating-an-Updateed-Image-Part1-Base-VHDX/" rel="permalink">Windows Image Tools | Creating an Updated Image Part 1
</a>
      
    </h2>
    
      <p class="page__meta"><i class="fa fa-clock-o" aria-hidden="true"></i> 




  3 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">One of the time consuming steps to deploying new VMs is the time spend managing Images and and applying patches. I’m not big on Golden images. I tend to use ...</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src=
          
            "http://localhost:4000/assets/images/default-teaser.png"
          
          alt="">
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="http://localhost:4000/Blog-Refactoring/" rel="permalink">Re-factoring the Blog
</a>
      
    </h2>
    
      <p class="page__meta"><i class="fa fa-clock-o" aria-hidden="true"></i> 




  1 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">Sometimes rebooting fixes everything

</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src=
          
            "http://localhost:4000/assets/images/default-teaser.png"
          
          alt="">
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="http://localhost:4000/windowsimagetools/Modifying-Fresh-VHDX/" rel="permalink">Windows Image Tools | Modify VHDX
</a>
      
    </h2>
    
      <p class="page__meta"><i class="fa fa-clock-o" aria-hidden="true"></i> 




  3 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">One of the time consuming steps to deploying new VMs is the time spend managing Images and and applying patches. I’m not big on Golden images. I tend to use ...</p>
  </article>
</div>
        
      </div>
    </div>
  
</div>

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    
    
      <li><a href="https://twitter.com/BladeFireLight"><i class="fa fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
    
    
    
      <li><a href="http://github.com/BladeFireLight"><i class="fa fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
    
    
    <li><a href="http://localhost:4000/feed.xml"><i class="fa fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2017 David Jones. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>
      </footer>
    </div>

    <script src="http://localhost:4000/assets/js/main.min.js"></script>





  
  <script type="text/javascript">
  	/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  	var disqus_shortname = 'blogbladefirelightcom';

  	/* * * DON'T EDIT BELOW THIS LINE * * */
  	(function() {
  		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  	})();

  	/* * * DON'T EDIT BELOW THIS LINE * * */
  	(function () {
  		var s = document.createElement('script'); s.async = true;
  		s.type = 'text/javascript';
  		s.src = '//' + disqus_shortname + '.disqus.com/count.js';
  		(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  	}());
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>






  </body>
</html>

